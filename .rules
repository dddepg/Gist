# Gist 开发规范 (SPEC)

## 1. 开发环境与工具

*   **包管理器**：必须使用 **bun**。
*   **数据库工具**：可以使用 `sqlite3` 命令行工具检查数据库。

---

## 2. 项目愿景与架构概览

本项目旨在构建一个高性能、轻量级、且深度集成 AI 能力的现代化 RSS 阅读器。

*   **核心目标**：全格式 Feed 支持、沉浸式阅读体验、AI 自动化摘要/翻译。
*   **技术栈**：
    *   **前端**：React 19.2 + Vite + TypeScript + shadcn/ui + Tailwind CSS v4。
    *   **后端**：Go 1.25.5+ + Echo 框架。
    *   **解析/存储**：`gofeed` + `modernc.org/sqlite` (纯 Go 驱动)。
    *   **AI 层**：OpenAI SDK / Anthropic (支持 BYOK 模式)。

---

## 3. 核心架构原则

*   **无 CGO 依赖**：为实现极致的跨平台移植性（特别是 Docker 构建），数据库必须选用 `modernc.org/sqlite`。
*   **安全优先 (Security First)**：所有输入视为不可信，必须进行验证和清洗。
*   **高内聚低耦合**：模块间通过接口交互，严禁跨层级直接访问内部实现。
*   **类型安全**：利用 Go 和 TypeScript 类型系统消除潜在错误，严禁滥用 `any` 或 `interface{}`。
*   **性能优先**：针对 RSS 长列表场景，必须实现虚拟列表 (Virtualization) 和异步处理。

---

## 4. 后端开发规范 (Go)

### 4.1 代码结构与分层
遵循 `Handler -> Service -> Repository` 严格分层模式：
*   **Handler (Transport Layer)**：仅处理 HTTP 协议转换（参数绑定、DTO 转换、状态码）。**禁止**编写业务逻辑。
*   **Service (Business Layer)**：纯粹业务逻辑，必须定义为 `interface` 以解耦和测试。
*   **Repository (Data Layer)**：纯粹数据访问，**禁止**包含业务判断。
*   **依赖注入**：通过构造函数注入依赖，配置对象除外，**禁止**使用全局状态变量。
*   **可见性控制**：仅公开必要的 API（首字母大写），私有逻辑严格保持小写。

### 4.2 数据存储 (Storage)
*   **驱动模式**：初始化 SQLite 时必须启用 `PRAGMA journal_mode = WAL;` 以提升并发性能。
*   **全文检索**：建立 `entries_fts` 虚拟表（unicode61 分词），通过 Trigger 自动同步主表数据。
*   **ORM 规范**：使用 GORM 时必须使用参数绑定（`?`），**严禁**字符串拼接 SQL。
*   **Schema 同步**：修改数据库结构后，**必须**同步更新本文档的 Schema 定义。

#### 4.2.1 数据库 Schema

**folders** - 文件夹表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | Snowflake ID |
| name | TEXT | NOT NULL | 文件夹名称 |
| parent_id | INTEGER | FK -> folders(id) ON DELETE CASCADE | 父文件夹 ID |
| created_at | TEXT | NOT NULL | 创建时间 (RFC3339) |
| updated_at | TEXT | NOT NULL | 更新时间 (RFC3339) |

**feeds** - 订阅源表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | Snowflake ID |
| folder_id | INTEGER | FK -> folders(id) ON DELETE SET NULL | 所属文件夹 |
| title | TEXT | NOT NULL | 订阅标题 |
| url | TEXT | NOT NULL UNIQUE | Feed URL |
| site_url | TEXT | | 网站首页 URL |
| description | TEXT | | 订阅描述 |
| icon_path | TEXT | | 图标文件路径 (如 example.com.png) |
| etag | TEXT | | HTTP ETag (Conditional GET) |
| last_modified | TEXT | | HTTP Last-Modified |
| error_message | TEXT | | 获取/刷新错误信息 |
| created_at | TEXT | NOT NULL | 创建时间 |
| updated_at | TEXT | NOT NULL | 更新时间 |

**entries** - 文章表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | Snowflake ID |
| feed_id | INTEGER | NOT NULL, FK -> feeds(id) ON DELETE CASCADE | 所属订阅 |
| title | TEXT | | 文章标题 |
| url | TEXT | | 文章链接 |
| content | TEXT | | 原始内容 (HTML) |
| readable_content | TEXT | | Readability 提取的正文 |
| thumbnail_url | TEXT | | 缩略图 URL |
| author | TEXT | | 作者 |
| published_at | TEXT | | 发布时间 |
| read | INTEGER | NOT NULL DEFAULT 0 | 已读状态 (0/1) |
| starred | INTEGER | NOT NULL DEFAULT 0 | 收藏状态 (0/1) |
| created_at | TEXT | NOT NULL | 创建时间 |
| updated_at | TEXT | NOT NULL | 更新时间 |

**entries_fts** - 全文检索虚拟表 (FTS5)
| 列名 | 说明 |
|------|------|
| title | 文章标题 |
| content | 文章内容 |
| author | 作者 |
| url | 文章链接 |

*Tokenizer*: `unicode61`

**settings** - 键值配置表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| key | TEXT | PRIMARY KEY | 配置键 |
| value | TEXT | NOT NULL | 配置值 |
| updated_at | TEXT | NOT NULL | 更新时间 (RFC3339) |

*已使用的配置键*:
- `ai.provider` - AI 提供商 (openai/anthropic/compatible)
- `ai.api_key` - API 密钥
- `ai.base_url` - 自定义 Base URL
- `ai.model` - 模型名称
- `ai.thinking` - 启用思考/推理 (true/false)
- `ai.thinking_budget` - 思考 token 预算 (Anthropic/Compatible)
- `ai.reasoning_effort` - 推理强度 (OpenAI/Compatible: none/minimal/low/medium/high/xhigh)
- `ai.summary_language` - AI 摘要输出语言 (zh-CN/en-US/ja 等)

**ai_summaries** - AI 摘要缓存表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | Snowflake ID |
| entry_id | INTEGER | NOT NULL, FK -> entries(id) ON DELETE CASCADE | 关联文章 |
| is_readability | INTEGER | NOT NULL DEFAULT 0 | 是否为 Readability 内容 (0/1) |
| language | TEXT | NOT NULL | 输出语言 |
| summary | TEXT | NOT NULL | 摘要内容 |
| created_at | TEXT | NOT NULL | 创建时间 (RFC3339) |

**ai_translations** - AI 翻译缓存表
| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | Snowflake ID |
| entry_id | INTEGER | NOT NULL, FK -> entries(id) ON DELETE CASCADE | 关联文章 |
| is_readability | INTEGER | NOT NULL DEFAULT 0 | 是否为 Readability 内容 (0/1) |
| language | TEXT | NOT NULL | 目标语言 |
| content | TEXT | NOT NULL | 翻译后内容 (HTML) |
| created_at | TEXT | NOT NULL | 创建时间 (RFC3339) |

#### 4.2.2 索引
```sql
idx_folders_parent_id    ON folders(parent_id)
idx_feeds_folder_id      ON feeds(folder_id)
idx_entries_feed_id      ON entries(feed_id)
idx_entries_read         ON entries(read)
idx_entries_starred      ON entries(starred)
idx_entries_feed_read    ON entries(feed_id, read)
idx_entries_feed_url     ON entries(feed_id, url) UNIQUE
idx_ai_summaries_entry_mode ON ai_summaries(entry_id, is_readability, language) UNIQUE
idx_ai_translations_entry_mode ON ai_translations(entry_id, is_readability, language) UNIQUE
```

#### 4.2.3 触发器
```sql
entries_ai  -- AFTER INSERT: 同步插入 entries_fts
entries_ad  -- AFTER DELETE: 同步删除 entries_fts
```

### 4.3 网络与解析 (Parser)
*   **宽容解析**：使用 `gofeed` 处理各类非标准 Feed。
*   **流量优化**：必须实现 **Conditional GET**。
    *   存储 `ETag` 和 `Last-Modified`。
    *   请求头携带 `If-None-Match` 和 `If-Modified-Since`。
    *   响应 304 时跳过解析。

### 4.4 功能特性集成
*   **AI 能力**：
    *   **BYOK 架构**：后端提供统一 Proxy，API Key 由用户端提供。
    *   **异步处理**：摘要/翻译任务必须进队列异步执行，不阻塞 Feed 更新。
*   **API 文档 (Swagger)**：
    *   **注解驱动**：在 Handler 中使用 `swag` 注解定义规范。
    *   **自动化**：API 更新后必须运行 `swag init -g cmd/server/main.go --parseDependency --parseInternal` 重新生成文档。
    *   **UI**：集成 `echo-swagger` 暴露 `/swagger/index.html`。

### 4.5 安全防御
*   **输入验证**：Handler 层必须校验所有 Query/Body/Path 参数。
*   **路径安全**：文件操作必须使用 `filepath.Clean` 防御路径穿越。
*   **敏感数据**：严禁硬编码密钥，严禁在日志中打印 Token 或密码哈希。

---

## 5. 前端开发规范 (TypeScript/React)

### 5.1 架构与组件
*   **目录结构**：
    *   `src/components/ui`: 通用组件。
    *   `src/components/{feature}/`: 业务组件 (如 `article/`)。
*   **逻辑分离**：UI 负责渲染，逻辑抽离至自定义 Hooks (`useFeedData` 等)。
*   **类型规范**：所有 Props 和 API 响应必须定义 Interface，**严禁**使用 `any`。

### 5.2 性能工程
*   **构建优化**：Vite 开启 `manualChunks` 拆分 React 核心与 UI 库。
*   **状态管理**：使用 `TanStack Query` 处理 Feed 数据缓存与预加载。
*   **渲染优化**：列表页禁止同步执行复杂的 Readability 转换，使用虚拟滚动。

### 5.3 安全与渲染 (XSS 防御)
*   **危险操作**：除非数据源经过 `unified` 管道清洗，否则**严禁**使用 `dangerouslySetInnerHTML`。
*   **依赖审计**：定期检查 `bun.lock` 漏洞。

---

## 6. API 与交互契约

*   **一致性**：后端 DTO 修改后，必须同步更新前端 `src/types/`。
*   **错误处理**：
    *   **后端**：返回标准化的 JSON 错误响应（含 `error` 字段）。
    *   **前端**：`api/index.ts` 统一拦截非 2xx 响应并抛出结构化错误。